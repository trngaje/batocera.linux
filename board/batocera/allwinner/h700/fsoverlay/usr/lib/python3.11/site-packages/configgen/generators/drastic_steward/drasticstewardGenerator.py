#!/usr/bin/env python

import Command
from generators.Generator import Generator
import controllersConfig
import shutil
from shutil import copyfile
import subprocess
from subprocess import Popen
import filecmp
import configparser
import os
import sys
import settings
from os import environ

class DrasticstewardGenerator(Generator):

    def generate(self, system, rom, playersControllers, metadata, guns, wheels, gameResolution):

        drastic_root = "/userdata/system/configs/drastic_steward"
        drastic_bin = "/userdata/system/configs/drastic_steward/drastic"
        steward_bin = "/userdata/system/configs/drastic_steward/drastic-steward"
        if not os.path.exists(drastic_root):
            shutil.copytree("/usr/share/drastic_steward", drastic_root)

        if not os.path.exists(drastic_bin) or not filecmp.cmp("/usr/bin/drastic", drastic_bin):
            shutil.copyfile("/usr/bin/drastic", drastic_bin)
            os.chmod(drastic_bin, 0o0775)
        
        if not os.path.exists(steward_bin) or not filecmp.cmp("/usr/share/drastic_steward/drastic-steward", steward_bin):
            shutil.copyfile("/usr/share/drastic_steward/drastic-steward", steward_bin)
            os.chmod(steward_bin, 0o0775)

        commandArray = [steward_bin, rom]
        return Command.Command(
            array=commandArray,
            env={
                'DISPLAY': '0.0',
                'LIB_FB': '3',
                'SDL_GAMECONTROLLERCONFIG': controllersConfig.generateSdlGameControllerConfig(playersControllers)
            })
